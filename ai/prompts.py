# ai/prompts.py

# --- CORE PROMPTS (Instructions only, no data placeholders) ---

ANALYZE_MATCH_PROMPT_CORE = """
Задача: Проанализируй на соответствие резюме и вакансию. Ответь на русском языке.

Проведи анализ и предоставь:
1. Процент соответствия резюме требованиям вакансии (число от 0 до 100) и кол-во полностью покрытых требований из общего кол-ва требований (например, 7 из 9).
2. Список наиболее покрытых требований вакансии с резюме (до 5 пунктов)
3. Список не покрытых требований вакансии (до 5 пунктов)

Вход: 1) ВАКАНСИЯ (полный текст вакансии ниже), 2) РЕЗЮМЕ (полный текст резюме ниже). 3) Параметр alpha (по умолчанию 0.8) — вес ключевых требований.

Выполняй шаги автоматически, строго и реалистично:

1) Извлечение требований:
- Разбей ВАКАНСИЯ на требования (буллет/предложение/фраза). id: r1, r2, ...
- Убери дубли/сливаем близкие по смыслу.

2) Классификация key/nonkey и importance:
- key если есть must|required|обязательно|требуется|minimum|years|degree|сертификат|must have|необходимо|обязателен или если в первых 3–5 буллетах/заголовке/повторяется.
- importance: must/required/обязательно → 1.0; preferred/желательно → 0.6; приветствуется → 0.5.

3) Семантика (base_semantic входит в [0,1]):
- Оцени семантическое совпадение (synonyms, близкие термины). Присвой base_semantic: слабое=0.3, среднее=0.6, сильное=0.9, exact=1.0, нет=0.0.

4) Доказательства — вычисли evidence_multiplier входит в [0.2,1.0]:
- Считай количество упоминаний X в РЕЗЮМЕ по контексту (experience/projects/summary/skills/education).
- Секция вес: Experience=1.0, Projects=0.95, Summary=0.7, SkillsList=0.5, Education=0.3.
- Глаголы/контекст: implemented/led/designed/worked as → verb_mult=1.0; used/developed → 0.85; familiar/knowledge of → 0.45; "aware of"/"basic" → 0.25.
- Правило: если X встречается ≥2 раза в сильной секции (Experience/Projects) и verb_mult≥0.85 → evidence_multiplier = 1.0.
  Если X только в SkillsList (одно упоминание) → evidence_multiplier = 0.35.
  Если 1 упоминание в Experience без глагола → 0.6.
  Нормализуй по шкале 0.2..1.0.

5) Отрицательные сигналы:
- Если резюме явно содержит "no X", "without X", "не работает с X" → match = 0 и требование поместить в несоответствия.

6) Годы/уровни/сертификаты:
- Для требований "N лет": years_multiplier = min(M/N,1.0) где M — годы в резюме; если M не указано — years_multiplier = 0.8 (умеренная неопределённость).
- Для уровня Senior: если резюме явно Mid → level_multiplier = 0.6; если Junior → 0.3; если Senior → 1.0.
- Сертификаты must: если сертификат явно в резюме → match=1.0; если "в процессе"/"обучаюсь" → match=0.4.

7) Итоговый match для требования:
- match_raw = base_semantic * evidence_multiplier * verb_mult * years_multiplier * level_multiplier (игнорируй множитель если неприменимо).
- Если требование бинарное (сертификат/юридич/обязательное) — применяй строгую логику выше.
- Обрежь match_raw в [0.0,1.0]. Если match_raw < 0.05 — считаем 0.
- Округляй match при выводе до целых процентов.

8) Агрегация и итог:
- coverage_key = (Σ importance_i * match_i) / Σ importance_i по key (0..1). Если нет key — alpha_used=0.5.
- coverage_nonkey = (Σ importance_j * match_j) / Σ importance_j по nonkey (0..1).
- score_pct = 100 * (alpha_used * coverage_key + (1-alpha_used) * coverage_nonkey). Округлить до целого числа.

9) Критерий совпадения:
- Условие совпадения: match >= 0.5.


Дополнительно:
1. Длинна ответа должна быть не более 1200 символов.
2. Можно использовать разные эмодзи для каждого совпадения или несоответствия, чтобы пользователь мог визуально понять и оценить.
3. Если ключеные требования вакансии есть в соответствиях, то необходимо подобрать зеленый эмодзи привлекающий больше внимания на это ключевое соответствие.
4. Если ключеные требования вакансии есть в несоответствиях, то необходимо подобрать красный эмодзи привлекающий больше внимания на это ключевое несоответствие.

Возвращай ровно этот текст — ничего кроме него.

Формат ответа:
ПРОЦЕНТ СООТВЕТСТВИЯ: [score_pct]% ([K] из [N])

СОВПАДЕНИЯ:
- [эмодзи] [текст требования] (importance=[importance*100]% , match=[match*100]%)
...

НЕСООТВЕТСТВИЯ:
- [эмодзи] [текст требования] (importance=[importance*100]% , match=[match*100]%)
...

Где:
- [K] — количество требований с match >= 0.5, [N] — общее число требований.
- importance и match показываются в целых процентах (округление до ближайшего целого).
- Покажи все требования в двух разделах (совпадения/несоответствия). Сортируй внутри разделов по убыванию importance*match.
"""

GENERATE_COVER_LETTER_PROMPT_CORE = """
Задача: написать сопроводительное письмо для отклика на вакансию, основываясь на Резюме и Вакансии приложенных ниже.
Письмо должно быть вежливым, профессиональным и подчеркивать релевантный опыт кандидата.

1. Структура письма
а) Приветствие
- Нейтральное приветствие: «Добрый день» или «Здравствуйте».

б) Вступление
- Укажите, на какую вакансию откликаетесь.
- Кратко объясните, почему она вам интересна (например, совпадает с вашим опытом, интересами, карьерными планами).

в) Основная часть
- Сделайте акцент на 2–3 ключевых компетенциях, которые важны для вакансии.
- Подтвердите их конкретными примерами: результаты, цифры, достижения.
- Покажите, чем именно вы можете быть полезны работодателю.

г) Заключение
- Выразите готовность обсудить ваш опыт на собеседовании.
- Поблагодарите за внимание.

2. Стиль и тон
- Держите письмо кратким (обычно 100–150 слов).
- Пишите живо и по делу, избегая канцеляризмов («высокая коммуникабельность», «стрессоустойчивость» лучше заменить конкретными примерами).
- Покажите искренний интерес к компании и должности.

3. Важные нюансы
- Адаптируйте письмо под вакансию.
- Используйте язык работодателя: повторяйте ключевые термины из описания вакансии.
- Не пересказывайте дословно резюме — дополняйте его мотивацией и пояснениями.
- Проверяйте письмо на ошибки: орфографические, пунктуационные, стилистические.

4. Типичные ошибки
- Слишком длинный текст (никто не читает полстраницы без конкретики).
- Универсальное письмо, не отражающее интереса к конкретной компании.
- Перечисление обязанностей вместо достижений.
- Излишне официальный или, наоборот, чрезмерно неформальный тон.


Ограничения:
1. Длинна сопроводительного письма 100–150 слов.
2. Не должно содержать контактов, персональных данных.
3. Не должно быть призывов к действию.
4. Не должно быть вопросов.
"""

GENERATE_HR_CALL_PLAN_PROMPT_CORE = """
Задача: составить компактный план 15-минутного созвона с HR на основе исключительно приложенных Резюме и Вакансии. 
Не использовать никаких других источников. Язык — русский. 
Тон — **подстраиваться под тон вакансии** (если вакансия формальная — формальный, дружелюбная — дружелюбный и т.д.). 
Это универсальный промпт — не делай предположений про уровень/условия, ориенируйся только на данные в документах.

Ограничения:
1. Длина плана созвона 250-400 слов.
2. Не должно содержать контактов, персональных данных.
3. Ноль воды — только факты, короткие фразы.
4. Эмодзи использовать: ✅ 🔴 ℹ️ (по одному-два символа на пункт для быстрой визуальной оценки).
5. Никаких призывов к действию.

Обязательная структура вывода (в этом порядке):
1. **Краткое самопрезентование кандидата** — 2-3 коротких предложения (макс. 2 строки). Фокус на релевантном опыте/ключевом результате. (рекоменд. 1–2 мин)
2. **Тайминг созвона** — распределение 15 минут по блокам (в минутах).
3. **Вопросы от HR (5–10)** — кажд. вопрос 1 строка. Для каждого:
   - 🔴 *Красный флаг* — 1–2 слова/словосочетания.
   - ✅ *Пример корректного ответа* — 5–10 слов/1 предложение.
   HR-вопросы — только поверхностные (цель подтвердить пункты резюме), без глубоких технических деталей.
4. **Вопросы кандидата к HR (5–10)** — включить обязательно: 
   - позиция новая или нет; 
   - вилка (зарплатная); 
   - сколько времени занимает весь процесс найма; 
   - когда будет фидбек по текущему созвону.
   Для каждого вопроса:
   - 🔴 *Красный флаг* от HR (1–2 слова) — что считать тревожным/уклончивым ответом;
   - ✅ *Пример надёжного ответа HR* — коротко;
   - **Если ответ HR может быть уклончивым**, сразу давай короткий **скрипт-добивку** (1 короткая фраза-вопрос), чтобы кандидат немедленно уточнил (пример: «Конкретно: сколько этапов и примерные сроки?»).
5. **Подсказки кандидату** — 3–5 коротких советов (каждый 3–8 слов) как отвечать на возможные красные флаги.
6. **Формат** — короткие буллеты. Все «красные флаги» — только слова/словосочетания. Примеры правильных ответов — короткие и конкретные.
7. Все пункты списка должны быть пронумерованы и разбиты по блокам для легкой и быстрой навигации по ним.

Доп. правила:
- Используй только информацию из резюме и вакансии. Если какой-то пункт в них отсутствует — помечай это кратко (однослово: «нетданных») там, где логично.
- Не добавляй уточняющих вопросов в текст плана — план должен укладываться в 15 минут.
- Эмодзи: использовать набор ✅ 🔴 ℹ️ по усмотрению для визуального выделения.
- Если в резюме/вакансии противоречие — не делать выводов, просто отметить «несоответствие» (одно слово).
- Никаких глубоких техвопросов от HR — только подтверждение опыта/компетенций.

Примеры скриптов-добивок (включай, когда уместно):
- «Конкретно: сколько этапов и примерные сроки?»  
- «Можно указать примерный диапазон вилки?»  
- «Это новая позиция или замещение? Уточните, пожалуйста.»
"""

GENERATE_TECH_INTERVIEW_PLAN_PROMPT_CORE = """
Составь подробный план для технического собеседования по данной вакансии, основываясь на резюме.
План должен включать:
1. Возможные технические вопросы от интервьюера по требованиям из вакансии. 10-15 вопросов, сформулируй их кратко. Расставь красные флаги для ответов кандидата и приведи правильный пример ответа. Красные флаги должны быть краткими: словами или словосочетаниями. Примеры правильных ответов также должны быть краткими.
2. Вопросы, которые кандидат должен задать интервьюеру - техническому специалисту по требованиям из вакансии и по работе в этой компании. 10-15 вопросов, сформулируй их кратко. Расставь красные флаги для ответов кандидата и приведи правильный пример ответа. Красные флаги должны быть краткими: словами или словосочетаниями. Примеры правильных ответов также должны быть краткими.

Ограничения:
1. Длина ответа не более 10000 символов.
2. Не должно содержать контактов, персональных данных.
3. Никакой воды, только факты.
4. Обязательные вопросы от кандидата: позиция новая или нет, вилка, сколько времени занимает весь процесс найма, когда будет фидбек по текущему созвону.
5. В вопросах от HR не должно быть глубоких технических деталей, вопросы должны быть поверхностными, чаще всего HR своими вопросами лишь подтвердить указанный в резюме конкретный навык или опыт. Особенно если этот навык явно присутствует в вакансии.
6. Можно использовать разные смайлики, чтобы пользователь мог визуально быстро понять и оценить.
7. Не должно быть призывов к действию.
"""

# --- Verification Prompts ---

VERIFY_RESUME_PROMPT = """
Проанализируй текст и является ли следующий текст резюме.
Ориентируйся на следующие признаки резюме:

— Наличие персональных данных (ФИО, возраст, дата рождения, контакты, город проживания, гражданство).
— Указание желаемой должности, зарплаты, формата работы.
— Описание опыта работы с указанием компаний, должностей, обязанностей, достижений и технологий.
— Наличие раздела "Образование" с вузом, факультетом и специальностью.
— Перечисление навыков (hard skills, soft skills, языки).
— Дополнительная информация о себе, семье, личных качествах.
— Форматные признаки: разделы с заголовками ("Опыт работы", "Образование", "Навыки"), списки, хронология.

Если большинство этих признаков присутствует → это резюме.
Если текст не имеет структуры резюме (нет опыта работы, образования, контактов и т.д.) → это не резюме.

Ответь в формате JSON с тремя ключами:
- "is_resume": boolean (true, если это резюме, иначе false)
- "title": string (придумай краткое название резюме, например "Senior BI Analyst" или "Junior Frontend Developer", если это резюме, иначе null)
- "body": string (если это резюме, то очисти и структурируй его, убери лишний мусор и оставь только полезную информацию, иначе null)

Текст:
---
{text}
---
"""

VERIFY_VACANCY_PROMPT = """
Проанализируй текст и определи, является ли он описанием вакансии.
Ориентируйся на следующие признаки вакансии:

- Название должности/позиции (например, "Разработчик", "Аналитик", "Менеджер").
- Описание компании (чем занимается, ее ценности).
- Требования к кандидату (опыт, навыки, образование).
- Обязанности (что нужно будет делать).
- Условия работы (график, зарплата, бонусы, офис/удаленка).
- Контактная информация для отклика.

Если большинство этих признаков присутствует → это вакансия.
Если текст не содержит четких указаний на должность, требования и обязанности → это не вакансия.

Ответь в формате JSON с тремя ключами:
- "is_vacancy": boolean (true, если это вакансия, иначе false)
- "title": string (извлеки из текста название вакансии, например "Senior Python Developer", если это вакансия, иначе null)
- "body": string (если это вакансия, то очисти и структурируй ее, убери лишний мусор и оставь только полезную информацию, иначе null)

Текст:
---
{text}
---
"""


# --- FULL PROMPTS (for individual use, maintaining compatibility) ---

_TEXT_INPUT_SECTION = """

РЕЗЮМЕ:
---
{resume_text}
---

ВАКАНСИЯ:
+++
{vacancy_text}
+++
"""

ANALYZE_MATCH_PROMPT = ANALYZE_MATCH_PROMPT_CORE + _TEXT_INPUT_SECTION
GENERATE_COVER_LETTER_PROMPT = GENERATE_COVER_LETTER_PROMPT_CORE + _TEXT_INPUT_SECTION
GENERATE_HR_CALL_PLAN_PROMPT = GENERATE_HR_CALL_PLAN_PROMPT_CORE + _TEXT_INPUT_SECTION
GENERATE_TECH_INTERVIEW_PLAN_PROMPT = GENERATE_TECH_INTERVIEW_PLAN_PROMPT_CORE + _TEXT_INPUT_SECTION


# --- CONSOLIDATED PROMPT (for combined analysis) ---

CONSOLIDATED_ANALYSIS_PROMPT = f"""
Проанализируй предоставленные резюме и вакансию и выполни следующие задачи.

**Задачи:**

1.  **Анализ соответствия**:
    {ANALYZE_MATCH_PROMPT_CORE}

2.  **Сопроводительное письмо**:
    {GENERATE_COVER_LETTER_PROMPT_CORE}

3.  **План созвона с HR**:
    {GENERATE_HR_CALL_PLAN_PROMPT_CORE}

4.  **План технического собеседования**:
    {GENERATE_TECH_INTERVIEW_PLAN_PROMPT_CORE}

**Формат ответа:**

Твой ответ должен быть **только** JSON объектом и ничего больше. JSON должен иметь следующую структуру с ключами: "match_analysis", "cover_letter", "hr_call_plan", "tech_interview_plan".
Значения для этих ключей должны быть строками, содержащими результаты выполнения соответствующих задач в текстовом формате.

**Данные для анализа:**

РЕЗЮМЕ:
---
{{resume_text}}
---

ВАКАНСИЯ:
+++
{{vacancy_text}}
+++
"""
